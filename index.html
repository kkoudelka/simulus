<!--
  ~ Copyright (c) 2019. Jan Koupil, Karel Koudelka, all rights reserved
  -->

<!DOCTYPE HTML>
<html>

<head>
    <meta charset=utf-8/>
    <meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!--<script type="text/javascript" src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>-->
    <script type="text/javascript" src="./MDBootstrap/js/jquery-3.3.1.min.js"></script>
    <!-- Bootstrap tooltips -->
    <script type="text/javascript" src="./MDBootstrap/js/popper.min.js"></script>
    <!-- Bootstrap core JavaScript -->
    <script type="text/javascript" src="./MDBootstrap/js/bootstrap.min.js"></script>
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="./MDBootstrap/js/mdb.min.js"></script>
    <script type="text/javascript" src="./MDBootstrap/js/addons/jquery-ui.min.js"></script>
    <script type="text/javascript" src="./MDBootstrap/js/addons/jquery-ui-touch-punch.min.js"></script>

    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <script src="assets/simulus.js"></script>
    <script src="layout.js"></script>
    <script src="model.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
    <!-- Bootstrap core CSS -->
    <link href="./MDBootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Material Design Bootstrap -->
    <link href="./MDBootstrap/css/mdb.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/simulus.css">


</head>

<body>
<!-- Modal -->
<div class="modal fade right" id="navigation-modal" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalPreviewLabel" aria-hidden="true" data-backdrop='true'>
    <div class="modal-dialog modal-md modal-info modal-dialog-centered modal-notify" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="exampleModalPreviewLabel">Navigation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" class="text-white">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul>
                    <li>Mouse wheel - zoom X axis</li>
                    <li>Shift + Mouse wheel - zoom Y axis</li>
                    <li>Ctrl + Mouse - move</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
<div id="chartContainer" style="width: 100vw; height: 90vh; "></div>

<div id="draggable" class="card w-25 animated-transitions"
     style="z-index: 50; position: absolute; right: 20px; top: 20px;">
    <h5 class="card-header primary-color white-text">Variables</h5>
    <div class="card-body">
        <div class="container">
            <div class="row">
                <table id="variables" class="table" style="line-height: 1px;"></table>

            </div>
        </div>
    </div>
</div>

<div class="d-flex" style="position: absolute; bottom: 0; width: 90vw;">
    <button class="btn btn-outline-primary" id="toggleSimulation">Play/Pause</button>
    <button class="btn btn-outline-primary" id="stepSimulation">Step</button>
    <button class="btn btn-outline-primary" id="smallStepSimulation">Small Step</button>
    <button class="btn btn-outline-primary" id="minStepSimulation">Minimum step</button>
    <button class="btn btn-outline-primary" id="reload">Reload</button>
</div>


</div>

<script type="text/javascript">
    $(document).ready(function () {

        let chart = new CanvasJS.Chart("chartContainer", layout.chartProps);
        let simulus = new Simulus(new Model(), chart);
        window.simulus = simulus;
        simulus.render();
        simulus.displayVars();
        let shiftPressed = false;
        let controlPressed = false;
        let lastMousePosition = null;

        animationFrameId = null;

        function loop() {
            animationFrameId = window.requestAnimationFrame(loop);
            for (let i = 0; i < simulus.model.displayedPointRatio; i++) {
                if (!simulus.model.step()) { //stop simulation
                    window.cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
            }
            simulus.render();
            simulus.displayVars();
        }

        function step(divider) {
            window.cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
            for (let i = 0, l = simulus.model.displayedPointRatio / divider; i < l; i++) {
                simulus.model.step()  //stop simulation
            }
            simulus.render();
            simulus.displayVars();
        }

        $("#toggleSimulation").on('click', function () {
            if (animationFrameId === null) {
                animationFrameId = window.requestAnimationFrame(loop);
                $(this).addClass('btn-outline-success').removeClass('btn-outline-danger');
            } else {
                window.cancelAnimationFrame(animationFrameId);
                $(this).addClass('btn-outline-danger').removeClass('btn-outline-success');

                animationFrameId = null;
            }
        });

        $("#stepSimulation").on('click', function () {
            step(1);
        });

        $("#smallStepSimulation").on('click', function () {
            step(10);
        });

        $("#minStepSimulation").on('click', function () {
            step(simulus.model.displayedPointRatio);
        });

        $("#reload").on('click', function () {
            location.reload();
        });

        $('#draggable').draggable();

        $(window).bind('mousewheel', function (event) {

            if (event.originalEvent.wheelDelta >= 0) {
                if (shiftPressed) {
                    if (window.simulus.chart.options.axisY.maximum - window.simulus.chart.options.axisY.minimum < 20) {
                        window.simulus.chart.options.axisY.minimum += 0.2;
                        window.simulus.chart.options.axisY.maximum -= 0.2;
                    } else {

                        window.simulus.chart.options.axisY.minimum += 1;
                        window.simulus.chart.options.axisY.maximum -= 1;
                    }

                } else {
                    if (window.simulus.chart.options.axisX.maximum - window.simulus.chart.options.axisX.minimum < 20) {
                        window.simulus.chart.options.axisX.minimum += 0.2;
                        window.simulus.chart.options.axisX.maximum -= 0.2;
                    } else {

                        window.simulus.chart.options.axisX.minimum += 1;
                        window.simulus.chart.options.axisX.maximum -= 1;
                    }

                }


            } else {
                if (shiftPressed) {
                    window.simulus.chart.options.axisY.minimum -= 1;
                    window.simulus.chart.options.axisY.maximum += 1;
                } else {
                    window.simulus.chart.options.axisX.minimum -= 1;
                    window.simulus.chart.options.axisX.maximum += 1;
                }

            }
            simulus.chart.render();


        });


        $(document).keydown(function (e) {
            if (e.keyCode === 16) {
                shiftPressed = true;
            }
            if (e.keyCode === 17) {
                controlPressed = true;
            }
        }).keyup(function (e) {
            if (e.keyCode === 16) {
                shiftPressed = false;
            }
            if (e.keyCode === 17) {
                controlPressed = false;
                lastMousePosition = null;
            }
        });

        $('#navigation-modal').modal('show');


        $(document).mousemove(function (event) {
            if (!controlPressed) return;
            if (lastMousePosition === null) {
                lastMousePosition = {
                    x: event.pageX,
                    y: event.pageY,
                };
                return;
            }
            if (lastMousePosition.x !== event.pageX) {
                let scaleDiv = 250;
                if ((window.simulus.chart.options.axisX.maximum - window.simulus.chart.options.axisX.minimum < 5)) scaleDiv = 600;
                const diffX = (lastMousePosition.x - event.pageX) / scaleDiv;
                window.simulus.chart.options.axisX.minimum += diffX;
                window.simulus.chart.options.axisX.maximum += diffX;
            }
            if (lastMousePosition.y !== event.pageY) {
                let scaleDiv = 100;
                if ((window.simulus.chart.options.axisY.maximum - window.simulus.chart.options.axisY.minimum < 8)) scaleDiv = 300;
                const diffY = (lastMousePosition.y - event.pageY) / scaleDiv;
                window.simulus.chart.options.axisY.minimum -= diffY;
                window.simulus.chart.options.axisY.maximum -= diffY;
            }


            lastMousePosition = {
                x: event.pageX,
                y: event.pageY,
            };
            window.simulus.chart.render();
        });

        $("#draggable").hover(
            function () {
                $(this).removeClass("transparent");
            }, function () {
                $(this).addClass("transparent");
            }
        );
    });
</script>

</body>

</html>
